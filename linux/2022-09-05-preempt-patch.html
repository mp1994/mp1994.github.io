<!DOCTYPE HTML>
<html lang="en" >
    <head><meta charset="UTF-8">
<meta content="text/html; charset=utf-8" http-equiv="Content-Type"><title>Real-time PREEMPT patch for the Linux Kernel Â· Mattically</title><meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="description" content="Tech-related random-access memories
"><meta name="generator" content="Jekyll (using style of GitBook 3.2.3)"><meta name="author" content="Mattia Pesenti"><link rel="stylesheet" href="https://mp1994.github.io/gitbook/style.css">
<link rel="stylesheet" href="https://mp1994.github.io/gitbook/gitbook-plugin-fontsettings/website.css">
<link rel="stylesheet" href="https://mp1994.github.io/gitbook/gitbook-plugin-search-pro/search.css">

<link rel="stylesheet" href="https://mp1994.github.io/gitbook/rouge/github.css">

<meta name="HandheldFriendly" content="true"/>
<meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black">
<link rel="apple-touch-icon-precomposed" sizes="152x152" href="https://mp1994.github.io/gitbook/images/apple-touch-icon-precomposed-152.png">
<link rel="shortcut icon" href="https://mp1994.github.io/gitbook/images/favicon.ico" type="image/x-icon">

<script>
    MathJax = {
        tex: {
            inlineMath: [['$', '$'], ['\\(', '\\)']]
        },
        svg: {
            fontCache: 'global'
        }
    };
</script>

            <link rel="prev" href="https://mp1994.github.io/2boot/2022-04-25-perf-tuning.html" />
        

        
            <link rel="next" href="https://mp1994.github.io/linux/2023-02-07-deterministic-loops.html" />
        
    </head>
    <body>
        <div class="book"><div class="book-summary">
    <div id="book-search-input" role="search">
        <input type="text" placeholder="Type to search" />
    </div>
    <nav role="navigation">
        <ul class="summary">
            
            <li class="chapter" data-level="1.1" data-path="https://mp1994.github.io">
            
                <a href="https://mp1994.github.io/">
                    Mattically
                </a>
            </li>

            <li class="divider"></li>

            
            
                <li class="chapter" data-level="1.1" data-path="https://mp1994.github.io/2boot/">
            
                    <a href="https://mp1994.github.io/2boot/">
                        2boot
                    </a>
                    
                        
                    
                </li>
            
            
                <li class="chapter active" data-level="1.2" data-path="https://mp1994.github.io/linux/">
            
                    <a href="https://mp1994.github.io/linux/">
                        linux
                    </a>
                    
                        
                    
                </li>
            
            
                <li class="chapter" data-level="1.1" data-path="https://mp1994.github.io/meta/">
            
                    <a href="https://mp1994.github.io/meta/">
                        meta
                    </a>
                    
                        
                    
                </li>
            
            
                <li class="chapter" data-level="1.1" data-path="https://mp1994.github.io/pages/whoami/">
            
                    <a href="https://mp1994.github.io/pages/whoami/">
                        whoami
                    </a>
                    
                        
                    
                </li>
            


            <!--<li>
                <a href="https://github.com/sighingnow/jekyll-gitbook/fork" target="blank" class="gitbook-link">
                    Fork it Now!
                </a>
            </li>-->
        </ul>
    </nav>
</div><div class="book-body"><div class="body-inner">
    <div class="book-header" role="navigation">
        <!-- Title -->
        <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i>
            
                <a href="." >Real-time PREEMPT patch for the Linux Kernel</a>
            
        </h1>
    </div>
    <div class="page-wrapper" tabindex="-1" role="main">
        <div class="page-inner">
            <div id="book-search-results">
                <div class="search-noresults">
                    <section class="normal markdown-section">

                        
                            <h1 id="/linux/preempt-patch">Real-time PREEMPT patch for the Linux Kernel</h1>
                        

                        <p>This article provides a minimal guide to installing the PREEMPT RT patch for the Linux kernel on a general-purpose computer (Dell XPS 7390). This should work on <em>any</em> modern PC/laptop.</p>

<h3 id="preamble-real-time-applications">Preamble: Real-Time applications</h3>
<p>Computers may be used to interface or control <em>real-time systems</em>, i.e. systems that <em>must react to an external event like an interrupt within a defined time frame</em> <a href="https://wiki.linuxfoundation.org/realtime/documentation/start#documentation">[1]</a>.
Hence, such systems must always respond with a <strong>limited and deterministic delay</strong> to external events. Low-priority tasks must be preempted (i.e., interrupted) to meet such constrained deadlines; such tasks are then completed by the CPU once the higher-priority, real-time task is complete.</p>

<p>The main aim of the PREEMPT_RT patch is to minimize the amount of kernel code that is non-preemptible <a href="https://wiki.linuxfoundation.org/realtime/documentation/technical_details/start">[2]</a>.</p>

<p>A typical real-time application is running a control loop at a specific frequency. Kernel-level preemption allows the CPU to execute the loop at the specified rate (below a certain limit). Moreover, the PREEMPT_RT patch also enables high-resolution timers allowing precise timed scheduling.</p>

<h3 id="1--install-required-tools">1- Install required tools</h3>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>apt <span class="nb">install </span>build-essential bc curl <span class="se">\</span>
wget ca-certificates gnupg2 libssl-dev <span class="se">\</span>
lsb-release libelf-dev bison flex dwarves <span class="se">\</span>
zstd libncurses-dev dwarves
</code></pre></div></div>

<h3 id="2--prepare-the-build-environment">2- Prepare the build environment</h3>
<p>We are going to create a folder in the <code class="language-plaintext highlighter-rouge">$HOME</code> folder, where we will apply the patch and compile the kernel.</p>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cd
mkdir </span>kernel <span class="o">&amp;&amp;</span> <span class="nb">cd </span>kernel
</code></pre></div></div>

<h3 id="3--download-the-kernel-and-the-corresponding-patch">3- Download the kernel and the corresponding patch</h3>
<p>This guide was written after patching kernel <code class="language-plaintext highlighter-rouge">v5.4.19</code> with the PREEMPT RT patch version <code class="language-plaintext highlighter-rouge">rt-11</code>. We can download the kernel 
and the patch using <code class="language-plaintext highlighter-rouge">wget</code>, or browsing the public repository for the <a href="https://mirrors.edge.kernel.org/pub/linux/kernel/">kernel</a> and the <a href="https://mirrors.edge.kernel.org/pub/linux/kernel/projects/rt/">patch</a>, respectively.</p>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>wget https://mirrors.edge.kernel.org/pub/linux/kernel/v5.x/linux-5.4.19.tar.xz
wget https://mirrors.edge.kernel.org/pub/linux/kernel/projects/rt/5.4/older/patch-5.4.19-rt11.patch.xz
</code></pre></div></div>

<h3 id="4--extract-the-archives-and-apply-the-patch">4- Extract the archives and apply the patch</h3>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>xz <span class="nt">-d</span> <span class="k">*</span>.xz
<span class="nb">tar </span>xf linux-<span class="k">*</span>.tar
<span class="nb">cd </span>linux-<span class="k">*</span>/
patch <span class="nt">-p1</span> &lt; ../patch-<span class="k">*</span>.patch
</code></pre></div></div>

<p>The commands above use the regex wildcard <code class="language-plaintext highlighter-rouge">*</code> and thus will work independently of the version we are patching.</p>

<h3 id="5--configure-the-kernel">5- Configure the kernel</h3>
<p>First, we are going to copy our current configuration from the boot partition</p>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">cp</span> <span class="nt">-v</span> /boot/config-<span class="si">$(</span><span class="nb">uname</span> <span class="nt">-r</span><span class="si">)</span> .config
</code></pre></div></div>
<p>In the command above, <code class="language-plaintext highlighter-rouge">$(uname -r)</code> expands to the current kernel version (e.g., <code class="language-plaintext highlighter-rouge">5.4.0-124-generic</code> in my case) and copies it to the local file <code class="language-plaintext highlighter-rouge">.config</code>.
Now, we need to configure the kernel. Specifically, we need to set the preemption model to enable the full real-time capability.</p>

<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make olddefconfig
make menuconfig
</code></pre></div></div>

<p>The latest command will open a TUI (terminal user interface): navigate with the arrow keys and select:</p>

<ul>
<li><b>General Setup &gt; Preemption Model &gt; Fully Preemptible Kernel (Real-Time)</b></li>
<li><b>Cryptographic API &gt; Certificates for signature checking</b> (at the very bottom of the list) <b>&gt; Provide system-wide ring of trusted keys &gt; Additional X.509 keys for default system keyring &gt; "" </b>(i.e., remove "debian/canonical-certs.pem" from the text input field)</li>
</ul>

<p>Save to <code class="language-plaintext highlighter-rouge">.config</code> and exit.</p>

<h3 id="6--build-the-kernel-as-a-debian-package-and-install-with-dpkg">6- Build the kernel as a Debian package and install with <code class="language-plaintext highlighter-rouge">dpkg</code></h3>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>make <span class="nt">-j</span><span class="si">$(</span><span class="nb">nproc</span><span class="si">)</span> deb-pkg
<span class="nb">sudo </span>dpkg <span class="nt">-i</span> ../linux-headers-<span class="k">*</span>.deb ../linux-image-<span class="k">*</span>.deb
</code></pre></div></div>

<h3 id="7--reboot-and-verify">7- Reboot and verify</h3>
<p>The install process should have created the initial ramdisk file and the kernel file, and added the new boot entry to GRUB. We can verify with <code class="language-plaintext highlighter-rouge">ls -l /boot | grep rt</code>.</p>

<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nv">$ </span><span class="nb">ls</span> <span class="nt">-l</span> /boot/ | <span class="nb">grep </span>rt
config-5.4.19-rt11preempt
initrd.img-5.4.19-rt11preempt
System.map-5.4.19-rt11preempt
vmlinuz-5.4.19-rt11preempt
</code></pre></div></div>

<p>We can now reboot and select the RT kernel from GRUB. To verify all is set correctly, we can check the output of <code class="language-plaintext highlighter-rouge">uname -a</code> and verify that <code class="language-plaintext highlighter-rouge">cat /sys/kernel/realtime</code> returns <code class="language-plaintext highlighter-rouge">1</code>.</p>

<h4 id="note-1-uefi-and-secure-boot">Note 1: UEFI and Secure Boot</h4>
<p>Modern systems equipped with UEFI firmware (i.e., the <em>new</em> BIOS) often have secure boot enabled by default. This means that the system will boot only if the kernel is signed. This may be tricky to achieve when building our own kernel, as in this case. I therefore suggest to disable secure boot (especially in case of boot issues after trying out this guide).</p>

<h4 id="note-2-rt-permissions">Note 2: RT permissions</h4>
<p>It may be handy to allow the user to set real-time permissions to executable without needing root permission (i.e., without <code class="language-plaintext highlighter-rouge">sudo</code>). We can 
achieve this by adding the user to the <code class="language-plaintext highlighter-rouge">realtime</code> group.</p>
<link rel="stylesheet" type="text/css" href="/gitbook/style2.css" />

<div class="code-header">
    <button class="copy-code-button" aria-label="Copy code to clipboard"></button>
</div>
<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="nb">sudo </span>addgroup realtime
<span class="nb">sudo </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> realtime <span class="si">$(</span><span class="nb">whoami</span><span class="si">)</span>
</code></pre></div></div>

<div class="post-date">
    
    
    <br />
    <span class="post-date" style="color:#80a7ff">
        Published on September 5, 2022 
        
        --- Last modified February 10, 2023
        
    </span>
</div>

                    </section>
                </div><div class="search-results">
    <div class="has-results">
        <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
        <ul class="search-results-list"></ul>
    </div>
    <div class="no-results">
        <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
    </div>
</div></div>
        </div>
    </div>
</div>

                    <a href="https://mp1994.github.io/2boot/2022-04-25-perf-tuning.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page: Tuning KVM for Best Performance">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="https://mp1994.github.io/linux/2023-02-07-deterministic-loops.html" class="navigation navigation-next navigation-unique" aria-label="Next page: Deterministic and reliable execution of loop functions in C/C++">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </div>

            <script src="/assets/scripts/copyCode.js"></script>
            <script>
            var gitbook = gitbook || [];
            gitbook.push(function() {
                gitbook.page.hasChanged({
    "page": {
        "title": "Introduction",
        "level": "1.1",
        "depth": 1,
        
        "next": {
            "title": "Deterministic and reliable execution of loop functions in C/C++",
            "level": "1.2",
            "depth": 1,
            "path": "_posts/2023-02-07-deterministic-loops.md",
            "ref": "_posts/2023-02-07-deterministic-loops.md",
            "articles": []
        },
        
        "dir": "ltr"
    },    "config": {
        "plugins": ["fontsettings", "highlight", "livereload", "lunr", "search", "sharing", "theme-default", "livereload"],
        "styles": {
            "ebook": "styles/ebook.css",
            "epub": "styles/epub.css",
            "mobi": "styles/mobi.css",
            "pdf": "styles/pdf.css",
            "print": "styles/print.css",
            "website": "styles/website.css"
        },
        "pluginsConfig": {
            "fontsettings": {
                "family": "sans",
                "size": 2,
                "theme": "white"
            },
            "highlight": {},
            "livereload": {},
            "lunr": {
                "ignoreSpecialCharacters": false,
                "maxIndexSize": 1000000
            },
            "search": {},
            "sharing": {
                "all": ["facebook", "google", "twitter", "weibo", "instapaper"],
                "facebook": true,
                "google": false,
                "instapaper": false,
                "twitter": true,
                "vk": false,
                "weibo": false
            },
            "theme-default": {
                "showLevel": false,
                "styles": {
                    "ebook": "styles/ebook.css",
                    "epub": "styles/epub.css",
                    "mobi": "styles/mobi.css",
                    "pdf": "styles/pdf.css",
                    "print": "styles/print.css",
                    "website": "styles/website.css"
                }
            }
        },
        "theme": "default",
        "author": "Tao He",
        "pdf": {
            "pageNumbers": true,
            "fontSize": 12,
            "fontFamily": "Arial",
            "paperSize": "a4",
            "chapterMark": "pagebreak",
            "pageBreaksBefore": "/",
            "margin": {
                "right": 62,
                "left": 62,
                "top": 56,
                "bottom": 56
            }
        },
        "structure": {
            "langs": "LANGS.md",
            "readme": "README.md",
        },
        "variables": {},
        "title": "Mattically",
        "language": "en",
        "gitbook": "*"
    },
    "file": {
        "path": "_posts/2022-09-05-preempt-patch.md",
        "mtime": "2022-09-05 00:00:00 +0000",
        "type": "markdown"
    },
    "gitbook": {
        "version": "3.2.3",
        "time": "2023-02-10 11:55:32 +0000"
    },
    "basePath": "https://mp1994.github.io",
    "book": {
        "language": ""
    }
});
            });
            </script>
        </div><script src="https://mp1994.github.io/gitbook/gitbook.js"></script>
<script src="https://mp1994.github.io/gitbook/theme.js"></script>

<script src="https://mp1994.github.io/gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
<script src="https://mp1994.github.io/gitbook/gitbook-plugin-sharing/buttons.js"></script>

<!-- <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
<script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
<script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
<script src="../gitbook/gitbook-plugin-search/search.js"></script> -->

<script src="https://mp1994.github.io/gitbook/gitbook-plugin-search-pro/jquery.mark.min.js"></script>
<script src="https://mp1994.github.io/gitbook/gitbook-plugin-search-pro/search.js"></script>

<script type="text/javascript" id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js"></script>

<script async src="//static.getclicky.com/101356528.js"></script>
<noscript><p><img alt="Clicky" width="1" height="1" src="//in.getclicky.com/101356528ns.gif" /></p></noscript>
</body>
</html>